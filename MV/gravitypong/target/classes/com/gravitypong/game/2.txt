package com.gravitypong.game;

import com.gravitypong.game.GameObjects.Ball;
import com.gravitypong.game.GameObjects.Paddle;
import com.gravitypong.game.GravityStrategies.CenterGravity;
import com.gravitypong.game.GravityStrategies.DirectionalGravity;

import javafx.animation.AnimationTimer;
import javafx.application.Application;
import javafx.scene.Scene;
import javafx.scene.input.KeyCode;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.text.Font;
import javafx.scene.text.Text;
import javafx.stage.Stage;

public class Main extends Application {

    private static final int WIDTH = 800;
    private static final int HEIGHT = 600;

    private Pane root;
    private Paddle player, ai;
    private Ball ball;
    private Text scoreText;
    private int playerScore = 0, aiScore = 0;

    // Модулі
    private InputHandler input;
    private PhysicsEngine physics;
    
    // Налаштування
    private Difficulty currentDifficulty = Difficulty.MEDIUM;

    @Override
    public void start(Stage stage) {
        root = new Pane();
        root.setPrefSize(WIDTH, HEIGHT);
        root.setStyle("-fx-background-color: #222;");

        // 1. Ініціалізація фізики
        physics = new PhysicsEngine(WIDTH, HEIGHT);

        // 2. Створення світу
        initWorld();

        Scene scene = new Scene(root);
        input = new InputHandler(scene);

        // 3. Game Loop
        AnimationTimer timer = new AnimationTimer() {
            @Override
            public void handle(long now) {
                handleInput();
                updatePhysics();
                render();
            }
        };
        timer.start();

        stage.setTitle("SOLID Gravity Pong");
        stage.setScene(scene);
        stage.show();
    }

    private void initWorld() {
        player = new Paddle(30, HEIGHT / 2 - 50, Color.CYAN, currentDifficulty.paddleSpeed);
        ai = new Paddle(WIDTH - 50, HEIGHT / 2 - 50, Color.HOTPINK, currentDifficulty.paddleSpeed * 0.8);
        ball = new Ball(WIDTH / 2, HEIGHT / 2, currentDifficulty.ballSpeed);

        scoreText = new Text(WIDTH / 2 - 50, 50, "0 : 0");
        scoreText.setFill(Color.WHITE);
        scoreText.setFont(Font.font(30));

        root.getChildren().addAll(scoreText, player.getView(), ai.getView(), ball.getView());
    }

    private void handleInput() {
        if (input.isPressed(KeyCode.W)) player.moveUp();
        if (input.isPressed(KeyCode.S)) player.moveDown();

        // Зміна режимів на льоту (Тест Strategy Pattern)
        if (input.isPressed(KeyCode.DIGIT1)) {
            System.out.println("Mode: Zero Gravity");
            physics.setGravityStrategy(new DirectionalGravity(0.0, 0.0));
        }
        if (input.isPressed(KeyCode.DIGIT2)) {
            System.out.println("Mode: Earth Gravity");
            physics.setGravityStrategy(new DirectionalGravity(0.0, 0.2));
        }
        if (input.isPressed(KeyCode.DIGIT3)) {
            System.out.println("Mode: Black Hole Center");
            physics.setGravityStrategy(new CenterGravity(0.1));
        }
        if (input.isPressed(KeyCode.DIGIT4)) {
             System.out.println("Mode: Wind (Right)");
             physics.setGravityStrategy(new DirectionalGravity(0.1, 0.0));
        }
    }

    private void updatePhysics() {
        // AI Logic
        double aiCenter = ai.pos.y + ai.height / 2;
        if (ball.pos.y < aiCenter - 10) ai.moveUp();
        else if (ball.pos.y > aiCenter + 10) ai.moveDown();

        // Paddle width
        player.clamp(HEIGHT);
        ai.clamp(HEIGHT);

        // Physics Update step
        physics.update(ball, player, ai);

        // Goal Check
        int goal = physics.checkGoal(ball);
        if (goal != 0) {
            if (goal == 1) playerScore++; else aiScore++;
            scoreText.setText(playerScore + " : " + aiScore);
            resetBall();
        }
    }

    private void render() {
        player.render();
        ai.render();
        ball.render();
    }

    private void resetBall() {
        ball.pos.x = WIDTH / 2;
        ball.pos.y = HEIGHT / 2;
        // Скидаємо швидкість до базової для складності
        double dir = Math.random() > 0.5 ? 1 : -1;
        ball.velocity = new Vector2D(currentDifficulty.ballSpeed * dir, (Math.random() - 0.5) * 5);
    }

    public static void main(String[] args) {
        launch(args);
    }
}